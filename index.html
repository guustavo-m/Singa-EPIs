<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de EPIs</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="assets/css/styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <header>
    <h1>Registro de Almoxarife</h1>
    <img src="assets/img/Logo_Singapura.png" alt="Logo Singapura">
  </header>

  <main>
    <form id="formEPI">
      <div class="all">
        <div class="b1">
          <label for="nome">Nome do Funcionário</label>
          <input type="text" id="nome" required>

          <label for="obra">Obra</label>
          <input type="text" id="obra" required>

          <label for="operacao">Retirada</label>
          <select id="operacao" required>
            <option value="coleta">EPI</option>
            <option value="devolucao">Utensílio</option>
          </select>

          <label for="data">Data</label>
          <input type="date" id="data" required>

          <label for="epi">Nome do Item</label>
          <input type="text" id="epi" required>

          <label for="ca">CA do EPI</label>
          <input type="text" id="ca" placeholder="Caso não tenha CA, digite 0" required>
        </div>
        <div class="b2">
          <div class="camera">
            <div>
              <h3>Comprovação por Foto</h3>
            </div><br>
            <div class="cam">
              <video id="video" width="300" height="200" autoplay></video><br>
              <canvas id="fotoCanvas" width="300" height="200"></canvas>
            </div>
            <button type="button" onclick="tirarFoto()">Tirar Foto</button><br>
          </div>

          <div class="assinatura">
            <h3>Ou Assinatura Digital</h3><br>
            <canvas id="assinatura" width="300" height="200"></canvas><br>
            <button type="button" onclick="limparAssinatura()">Limpar Assinatura</button>
          </div>
        </div>
      </div>
      <div class="btnsave">
        <button type="submit">Salvar Registro</button>
      </div>
    </form>
  </main>

  <script>
    // O código agora está envolto em um evento que garante que o DOM está pronto.
    document.addEventListener('DOMContentLoaded', () => {

      // Ativar câmera
      const video = document.getElementById('video');
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => { video.srcObject = stream; })
        .catch(err => { alert("Erro ao acessar câmera: " + err); });

      // Captura de foto
      const fotoCanvas = document.getElementById("fotoCanvas");
      const ctxFoto = fotoCanvas.getContext("2d");

      window.tirarFoto = function () {
        ctxFoto.drawImage(video, 0, 0, fotoCanvas.width, fotoCanvas.height);
      };

      // Assinatura digital (mouse + touch)
      const canvas = document.getElementById("assinatura");
      const ctx = canvas.getContext("2d");
      let desenhando = false;

      function getPosicao(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches) {
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
          };
        } else {
          return { x: e.offsetX, y: e.offsetY };
        }
      }

      function desenhar(e) {
        if (!desenhando) return;
        const pos = getPosicao(e);
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "black";
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      }

      // Eventos mouse
      canvas.addEventListener("mousedown", (e) => {
        desenhando = true;
        const pos = getPosicao(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      });
      canvas.addEventListener("mouseup", () => {
        desenhando = false;
      });
      canvas.addEventListener("mousemove", desenhar);

      // Eventos touch
      canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        desenhando = true;
        const pos = getPosicao(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      });
      canvas.addEventListener("touchend", () => {
        desenhando = false;
      });
      canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        desenhar(e);
      });

      window.limparAssinatura = function () {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      };

      // Salvar dados e gerar PDF
      document.getElementById("formEPI").addEventListener("submit", function (e) {
        e.preventDefault();

        // Verificação para garantir que o formulário está sendo submetido
        console.log("Evento de submit acionado!");

        const registro = {
          nome: document.getElementById("nome").value,
          obra: document.getElementById("obra").value,
          operacao: document.getElementById("operacao").value,
          data: document.getElementById("data").value,
          epi: document.getElementById("epi").value,
          ca: document.getElementById("ca").value,
          foto: fotoCanvas.toDataURL(),
          assinatura: canvas.toDataURL()
        };

        // Criar PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const fundo = new Image();
        fundo.src = "assets/img/Fundo_Logo.png";

        const logo = new Image();
        logo.src = "assets/img/Logo_Singapura.png";

        // Carregar imagens antes de gerar o PDF
        Promise.all([
          new Promise(resolve => fundo.onload = resolve),
          new Promise(resolve => logo.onload = resolve)
        ]).then(() => {
          doc.addImage(fundo, "PNG", 50, 60, 120, 120, "", "FAST");
          doc.addImage(logo, "PNG", 150, 10, 40, 20);

          // Título
          doc.setFontSize(16);
          doc.setFont("helvetica", "bold");
          doc.setTextColor(113, 35, 61);
          doc.text("COMPROVANTE DE REGISTRO DE RETIRADA DE EPI", 20, 40);

          // Dados
          doc.setFontSize(12);
          doc.setFont("helvetica", "normal");
          doc.setTextColor(0, 0, 0);

          let y = 55;
          doc.text(`Nome do Colaborador: ${registro.nome}`, 20, y); y += 10;
          doc.text(`Obra: ${registro.obra}`, 20, y); y += 10;
          doc.text(`Retirada: ${registro.operacao}`, 20, y); y += 10;
          doc.text(`Data: ${registro.data}`, 20, y); y += 10;
          doc.text(`Nome do Item: ${registro.epi}`, 20, y); y += 10;
          doc.text(`CA do EPI: ${registro.ca}`, 20, y); y += 20;

          // Sessão comprovação
          doc.setFont("helvetica", "bold");
          doc.setTextColor(113, 35, 61);
          doc.text("COMPROVAÇÃO DO COLABORADOR", 20, y);
          y += 15;

          doc.setTextColor(0, 0, 0);
          doc.text("Foto", 40, y);
          doc.text("Assinatura", 140, y);
          y += 5;

          if (registro.foto) doc.addImage(registro.foto, "PNG", 20, y, 70, 50);
          if (registro.assinatura) doc.addImage(registro.assinatura, "PNG", 120, y, 70, 50);

          y += 65;
          doc.setDrawColor(113, 35, 61);
          doc.line(20, y, 190, y);

          // Salvar PDF
          doc.save(`Comprovante_EPI_${registro.nome}.pdf`);

          alert("Registro salvo e PDF gerado com sucesso!");
          document.getElementById("formEPI").reset();
          limparAssinatura();
          ctxFoto.clearRect(0, 0, fotoCanvas.width, fotoCanvas.height);
        }).catch(err => {
          console.error("Erro ao carregar imagens para o PDF:", err);
          alert("Ocorreu um erro ao gerar o PDF. Verifique os caminhos das imagens.");
        });
      });
    });
  </script>
</body>
</html>